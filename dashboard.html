<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Mercado Local</title>
    <link rel="stylesheet" href="assets/style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .dashboard-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .welcome-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .add-product-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .add-product-card h3 {
            margin-top: 0;
            color: #fff;
        }

        .form-row {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .form-row input {
            flex: 1;
            margin: 0;
        }

        .form-row button {
            width: auto;
            margin: 0;
            background: #4CAF50;
        }

        .products-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }

        .product-item {
            background: rgba(0, 0, 0, 0.2);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .product-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 4px;
            margin-bottom: 0.5rem;
        }

        .product-item h4 {
            margin: 0 0 0.5rem 0;
            color: #fff;
            overflow-wrap: break-word;
            word-wrap: break-word;
        }

        .product-item .price {
            color: #4CAF50;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .logout-btn {
            background: transparent;
            border: 1px solid #666;
            padding: 0.5rem 1rem;
            color: #ccc;
            border-radius: 4px;
            cursor: pointer;
        }

        .edit-btn {
            margin-top: 0.5rem;
            width: 100%;
            padding: 0.5rem;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
            }
            .form-row input, 
            .form-row select, 
            .form-row button {
                width: 100% !important;
            }
        }
    </style>
</head>

<body>
    <header>
        <div class="header-content">
            <img src="assets/logo.png" alt="Logo" class="logo">
            <h1>Painel do Vendedor</h1>
        </div>
    </header>
    <main class="dashboard-container">
        <div class="welcome-bar">
            <h2 id="store-name">Bem-vindo, Loja</h2>
            <button class="logout-btn" onclick="logout()">Sair</button>
        </div>

        <!-- Logo Upload -->
        <section class="add-product-card">
            <h3>Logo da Loja</h3>
            <form id="logo-form" class="form-row">
                <input type="file" id="store-logo" accept="image/*" required>
                <button type="submit">Atualizar Logo</button>
            </form>
            <div id="current-logo" style="margin-top: 10px;"></div>
        </section>

        <section class="add-product-card">
            <h3>Adicionar / Atualizar Pre√ßo</h3>
            <form id="add-product-form">
                <div class="form-row">
                    <input type="text" id="prod-name" placeholder="Nome do Produto (ex: Arroz 5kg)" required>
                    <input type="number" id="prod-price" placeholder="Pre√ßo (R$)" step="0.01" required>
                    <select id="prod-category" required style="flex: 1; padding: 0.8rem; border-radius: 6px; border: 1px solid #444; background: rgba(0, 0, 0, 0.2); color: #ffffff;">
                        <option value="" disabled selected>Categoria</option>
                        <option value="Alimentos">Alimentos</option>
                        <option value="Bebidas">Bebidas</option>
                        <option value="Limpeza">Limpeza</option>
                        <option value="Higiene">Higiene</option>
                        <option value="Hortifruti">Hortifruti</option>
                        <option value="A√ßougue">A√ßougue</option>
                        <option value="Outros">Outros</option>
                    </select>
                    <input type="number" id="prod-promo" placeholder="Promo√ß√£o (24h)" step="0.01" style="width: 130px;">
                    <input type="file" id="prod-image" accept="image/*" style="width: 200px;">
                    <button type="submit">Salvar</button>
                </div>
            </form>
        </section>

        <h3>Seus Produtos</h3>
        <div id="products-list" class="products-list">
            <!-- Products injected here -->
            <div style="color: #888; grid-column: 1/-1; text-align: center;">Carregando produtos...</div>
        </div>
    </main>

    <!-- Bot√£o Flutuante de Suporte -->
    <a href="https://wa.me/5563992225774" target="_blank" class="floating-support-btn" title="Falar com Suporte">üéß</a>

    <script>
        const supabaseUrl = 'https://licvfuzvvbmjdvcooogo.supabase.co';
        const supabaseKey = 'sb_publishable_8hwXxxU7C4owwVmlc4FvPg_0pEXUFK-';
        const supabase = supabase.createClient(supabaseUrl, supabaseKey); 
            
            

        // Auth Check
        const storeId = localStorage.getItem('store_id');
        const storeName = localStorage.getItem('store_name');
        let storeLogo = localStorage.getItem('store_logo'); // Use let to allow update
        if (!storeId) window.location.href = 'login.html';

        document.getElementById('store-name').textContent = `Loja: ${storeName || 'Comerciante'}`;
        
        function getFullUrl(path) {
            if (!path || path === 'null' || path.startsWith('http')) {
                return path;
            }
            return `${API_BASE_URL}${path}`;
        }

        if (storeLogo && storeLogo !== 'null') {
            document.getElementById('current-logo').innerHTML = `<img src="${getFullUrl(storeLogo)}" style="height: 60px; border-radius: 50%;">`;
        }

        // Buscar dados atualizados da loja (garante que a logo apare√ßa)
        fetch(`${API_BASE_URL}/api/store/${storeId}`)
            .then(res => res.json())
            .then(data => {
                if (data.logo_url) {
                    const fullLogoUrl = getFullUrl(data.logo_url);
                    localStorage.setItem('store_logo', fullLogoUrl);
                    document.getElementById('current-logo').innerHTML = `<img src="${fullLogoUrl}" style="height: 60px; border-radius: 50%;">`;
                }
            }).catch(err => {
                console.error("Failed to fetch store details:", err)
            });

        function logout() {
            localStorage.clear();
            window.location.href = 'index.html';
        }

        let currentProducts = [];

        async function loadProducts() {
            const container = document.getElementById('products-list');
            try {
                const res = await fetch(`${API_BASE_URL}/api/merchant/products?store_id=${storeId}`);
                 if (!res.ok) {
                    throw new Error(`Server responded with ${res.status}`);
                }
                const products = await res.json();
                currentProducts = products;

                if (products.length === 0) {
                    container.innerHTML = '<div style="color: #888; grid-column: 1/-1; text-align: center;">Nenhum produto cadastrado ainda.</div>';
                    return;
                }

                container.innerHTML = products.map((p, index) => `
                    <div class="product-item">
                        ${p.image_url ? `<img src="${getFullUrl(p.image_url)}" alt="${p.name}">` : ''}
                        <h4>${p.name}</h4>
                        ${p.category ? `<span style="font-size: 0.8rem; background: #e91e63; padding: 2px 6px; border-radius: 4px; color: white;">${p.category}</span>` : ''}
                        
                        ${(p.promo_price && new Date(p.promo_expires_at) > new Date()) 
                            ? `
                                <div style="margin-top:5px;">
                                    <span style="text-decoration: line-through; color: #888; font-size: 0.9rem;">R$ ${parseFloat(p.price).toFixed(2)}</span>
                                    <span class="price" style="color: #ffeb3b;">R$ ${parseFloat(p.promo_price).toFixed(2)}</span>
                                    <div style="font-size: 0.7rem; color: #ffeb3b;">üïí 24h ativa</div>
                                </div>`
                            : `<span class="price">R$ ${parseFloat(p.price).toFixed(2)}</span>`
                        }
                        <button class="edit-btn" onclick="triggerEdit(${index})">Editar</button>
                    </div>
                `).join('');
            } catch (err) {
                console.error("Failed to load products:", err);
                container.innerHTML = '<div style="color: #ff9800; grid-column: 1/-1; text-align: center;">Falha ao carregar produtos. Verifique sua conex√£o ou contate o suporte.</div>';
            }
        }

        // Fun√ß√£o para preencher o formul√°rio com dados do produto selecionado
        window.triggerEdit = (index) => {
            const p = currentProducts[index];
            if (p) {
                document.getElementById('prod-name').value = p.name;
                document.getElementById('prod-price').value = p.price;
                document.getElementById('prod-promo').value = (p.promo_price && new Date(p.promo_expires_at) > new Date()) ? p.promo_price : '';
                document.getElementById('prod-category').value = p.category || '';
                document.getElementById('add-product-form').scrollIntoView({ behavior: 'smooth' });
            }
        };

       // 1. Fun√ß√£o auxiliar para reduzir o peso da imagem
function compressLogo(file) {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);

        reader.onload = (e) => {
            const img = new Image();
            img.src = e.target.result;

            img.onload = () => {
                const canvas = document.createElement('canvas');

                const MAX_SIZE = 500; // logos n√£o precisam ser grandes
                const scale = Math.min(MAX_SIZE / img.width, MAX_SIZE / img.height, 1);

                canvas.width = img.width * scale;
                canvas.height = img.height * scale;

                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                // PNG preserva texto e bordas
                canvas.toBlob(
                    (blob) => resolve(blob),
                    'image/png',
                    0.9
                );
            };
        };
    });
}

function compressProductImage(file) {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);

        reader.onload = (e) => {
            const img = new Image();
            img.src = e.target.result;

            img.onload = () => {
                const canvas = document.createElement('canvas');

                const MAX_WIDTH = 900;
                const scale = Math.min(MAX_WIDTH / img.width, 1);

                canvas.width = img.width * scale;
                canvas.height = img.height * scale;

                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                // JPEG equilibrado
                canvas.toBlob(
                    (blob) => resolve(blob),
                    'image/jpeg',
                    0.85
                );
            };
        };
    });
}


document.getElementById('logo-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const fileInput = document.getElementById('store-logo');
    const file = fileInput.files[0];
    if (!file) return;

    try {
        // 1. Envia para o Storage do Supabase (Bucket "logos")
        const fileName = `logo-${storeId}-${Date.now()}.jpg`;
        const { data, error } = await supabase.storage
            .from('logos')
            .upload(fileName, file);

        if (error) throw error;

        // 2. Pega a URL p√∫blica gerada
        const { data: { publicUrl } } = supabase.storage
            .from('logos')
            .getPublicUrl(fileName);

        // 3. Avisa o seu servidor no Render para salvar essa nova URL no banco
        await fetch(`${API_BASE_URL}/api/merchant/update-logo`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ store_id: storeId, logo_url: publicUrl })
        });

        document.getElementById('current-logo').innerHTML = `<img src="${publicUrl}" style="height:60px; border-radius:50%;">`;
        alert('Logo salva permanentemente!');
    } catch (err) {
        console.error(err);
        alert('Erro ao usar Supabase');
    }
});
        // Upload Produto
document.getElementById('add-product-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const name = document.getElementById('prod-name').value;
    const price = document.getElementById('prod-price').value;
    const promoPrice = document.getElementById('prod-promo').value;
    const category = document.getElementById('prod-category').value;
    // Substitua a l√≥gica de submiss√£o do formul√°rio de produto
const productFile = document.getElementById('product-image').files[0];
if (productFile) {
    // 1. Upload da imagem do produto para o Supabase
    const fileName = `prod-${Date.now()}.jpg`;
    const { data, error } = await supabase.storage
        .from('produtos')
        .upload(fileName, productFile);

    if (error) throw error;

    // 2. Obter a URL p√∫blica da imagem
    const { data: { publicUrl } } = supabase.storage
        .from('produtos')
        .getPublicUrl(fileName);

    // 3. Enviar os dados completos para o seu Backend no Render
    const productData = {
        name: document.getElementById('product-name').value,
        price: document.getElementById('product-price').value,
        category: document.getElementById('product-category').value,
        image_url: publicUrl, // Agora enviamos o link do Supabase
        store_id: storeId
    };

    await fetch(`${API_BASE_URL}/api/products`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(productData)
    });
    
    alert('Produto cadastrado com sucesso!');
}
});


        // Initial load
        loadProducts();

        // Footer Global - JBSousaTech
        const footer = document.createElement('footer');
        footer.innerHTML = `
            <div style="text-align: center; padding: 20px; margin-top: 40px; border-top: 1px solid #333; color: #888; font-size: 0.9rem;">
                &copy; ${new Date().getFullYear()} JbsousaTech - Todos os direitos reservados
            </div>
        `;
        document.body.appendChild(footer);
    </script>
</body>

</html>