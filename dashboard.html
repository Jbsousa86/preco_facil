<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Mercado Local</title>
    <link rel="stylesheet" href="assets/style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .dashboard-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .welcome-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .add-product-card {
            background: linear-gradient(135deg, hsl(var(--primary-h, 220), var(--primary-s, 90%), 92%), #ffffff);
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            border: 1px solid hsl(var(--primary-h, 220), var(--primary-s, 90%), 85%);
        }

        .add-product-card h3 {
            margin-top: 0;
            color: var(--text-main, #1f2937);
        }

        .form-row {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .form-row input {
            flex: 1;
            margin: 0;
        }

        .form-row button {
            width: auto;
            margin: 0;
            background: #4CAF50;
        }

        .products-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }

        .product-item {
            background: linear-gradient(135deg, hsl(var(--primary-h, 220), var(--primary-s, 90%), 92%), #ffffff);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid hsl(var(--primary-h, 220), var(--primary-s, 90%), 85%);
        }

        .product-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 4px;
            margin-bottom: 0.5rem;
        }

        .product-item h4 {
            margin: 0 0 0.5rem 0;
            color: var(--text-main, #1f2937);
            overflow-wrap: break-word;
            word-wrap: break-word;
        }

        .product-item .price {
            color: #4CAF50;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .logout-btn {
            background: transparent;
            border: 1px solid #666;
            padding: 0.5rem 1rem;
            color: #ccc;
            border-radius: 4px;
            cursor: pointer;
        }

        .edit-btn {
            margin-top: 0.5rem;
            width: 100%;
            padding: 0.5rem;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .delete-btn {
            margin-top: 0.5rem;
            width: 100%;
            padding: 0.5rem;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
            }

            .form-row input,
            .form-row select,
            .form-row button {
                width: 100% !important;
            }
        }
    </style>
</head>

<body>
    <header>
        <div class="header-content">
            <img src="assets/logo.png" alt="Logo" class="logo">
            <h1>Painel do Vendedor</h1>
        </div>
    </header>
    <main class="dashboard-container">
        <div class="welcome-bar">
            <h2 id="store-name">Bem-vindo, Loja</h2>
            <button class="logout-btn" onclick="logout()">Sair</button>
        </div>

        <!-- Logo Upload -->
        <section class="add-product-card">
            <h3>Logo da Loja</h3>
            <form id="logo-form">
                <div class="form-row">
                    <div style="display: flex; gap: 5px; align-items: center; flex: 1; min-width: 300px;">
                        <select id="logo-source-type"
                            style="padding: 0.8rem; border-radius: 6px; border: 1px solid #d1d5db; background: #f9fafb; width: 100px;">
                            <option value="file">Arquivo</option>
                            <option value="url">Link</option>
                        </select>
                        <div id="logo-file-container" style="flex: 1;">
                            <input type="file" id="store-logo" accept="image/*" style="width: 100%;">
                        </div>
                        <div id="logo-url-container" style="flex: 1; display: none;">
                            <input type="url" id="store-logo-url" placeholder="Link da Logo (Supabase ou outro)"
                                style="width: 100%;">
                        </div>
                    </div>
                    <button type="submit" style="width: auto;">Atualizar Logo</button>
                </div>
            </form>
            <div id="current-logo" style="margin-top: 10px;"></div>
        </section>

        <section class="add-product-card">
            <h3>Adicionar / Atualizar Pre√ßo</h3>
            <form id="add-product-form">
                <input type="hidden" id="prod-id">
                <div class="form-row">
                    <input type="text" id="prod-name" placeholder="Nome do Produto (ex: Arroz 5kg)" required>
                    <input type="number" id="prod-price" placeholder="Pre√ßo (R$)" step="0.01" required>
                    <select id="prod-category" required
                        style="flex: 1; padding: 0.8rem; border-radius: 6px; border: 1px solid #d1d5db; background: #f9fafb; color: var(--text-main, #1f2937);">
                        <option value="" disabled selected>Categoria</option>
                        <option value="Alimentos">Alimentos</option>
                        <option value="Bebidas">Bebidas</option>
                        <option value="Limpeza">Limpeza</option>
                        <option value="Higiene">Higiene</option>
                        <option value="Hortifruti">Hortifruti</option>
                        <option value="A√ßougue">A√ßougue</option>
                        <option value="Outros">Outros</option>
                    </select>
                    <input type="number" id="prod-promo" placeholder="Promo√ß√£o (24h)" step="0.01" style="width: 130px;">

                    <div style="display: flex; gap: 5px; align-items: center; flex: 1; min-width: 300px;">
                        <select id="image-source-type"
                            style="padding: 0.8rem; border-radius: 6px; border: 1px solid #d1d5db; background: #f9fafb; width: 100px;">
                            <option value="file">Arquivo</option>
                            <option value="url">Link</option>
                        </select>
                        <div id="image-file-container" style="flex: 1;">
                            <input type="file" id="prod-image" accept="image/*" style="width: 100%;">
                        </div>
                        <div id="image-url-container" style="flex: 1; display: none;">
                            <input type="url" id="prod-image-url" placeholder="https://exemplo.com/imagem.jpg"
                                style="width: 100%;">
                        </div>
                    </div>

                    <button type="submit">Salvar</button>
                </div>
            </form>
        </section>

        <h3>Seus Produtos</h3>
        <div id="products-list" class="products-list">
            <!-- Products injected here -->
            <div style="color: #888; grid-column: 1/-1; text-align: center;">Carregando produtos...</div>
        </div>
    </main>

    <!-- Bot√£o Flutuante de Suporte -->
    <a href="https://wa.me/5563992225774" target="_blank" class="floating-support-btn" title="Falar com Suporte">üéß</a>

    <script>
        // --- CONFIGURA√á√ïES INICIAIS ---
        const API_BASE_URL = 'https://preco-facil.onrender.com';
        const supabaseUrl = 'https://licvfuzvvbmjdvcooogo.supabase.co';
        const supabaseKey = 'sb_publishable_8hwXxxU7C4owwVmlc4FvPg_0pEXUFK-'; // Verifique se esta chave est√° correta no painel
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

        const storeId = localStorage.getItem('store_id');
        const storeName = localStorage.getItem('store_name');
        let storeLogo = localStorage.getItem('store_logo');
        let merchantProducts = []; // Para guardar a lista de produtos para edi√ß√£o


        if (!storeId) window.location.href = 'login.html';

        document.getElementById('store-name').textContent = `Loja: ${storeName || 'Comerciante'}`;

        // --- FUN√á√ïES UTILIT√ÅRIAS ---
        document.getElementById('image-source-type').addEventListener('change', (e) => {
            const isUrl = e.target.value === 'url';
            document.getElementById('image-file-container').style.display = isUrl ? 'none' : 'block';
            document.getElementById('image-url-container').style.display = isUrl ? 'block' : 'none';

            // Clear inputs when switching
            if (isUrl) {
                document.getElementById('prod-image').value = '';
            } else {
                document.getElementById('prod-image-url').value = '';
            }
        });

        document.getElementById('logo-source-type').addEventListener('change', (e) => {
            const isUrl = e.target.value === 'url';
            document.getElementById('logo-file-container').style.display = isUrl ? 'none' : 'block';
            document.getElementById('logo-url-container').style.display = isUrl ? 'block' : 'none';
            // Clear inputs when switching
            if (isUrl) {
                document.getElementById('store-logo').value = '';
            } else {
                document.getElementById('store-logo-url').value = '';
            }
        });

        function getFullUrl(path) {
            if (!path || path === 'null' || String(path).trim() === '') return '';
            const cleanPath = String(path).trim();
            if (cleanPath.startsWith('http')) return cleanPath;
            const finalPath = cleanPath.startsWith('/') ? cleanPath : `/${cleanPath}`;
            return `${API_BASE_URL}${finalPath}`;
        }

        function compressImage(file, isLogo = false) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_SIZE = isLogo ? 500 : 900;
                        const scale = Math.min(MAX_SIZE / img.width, MAX_SIZE / img.height, 1);
                        canvas.width = img.width * scale;
                        canvas.height = img.height * scale;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        canvas.toBlob((blob) => resolve(blob), isLogo ? 'image/png' : 'image/jpeg', 0.8);
                    };
                };
            });
        }

        // --- CARREGAMENTO INICIAL ---
        if (storeLogo && storeLogo !== 'null') {
            document.getElementById('current-logo').innerHTML = `<img src="${getFullUrl(storeLogo)}" style="height: 60px; border-radius: 50%;">`;

            // Se a logo for um link externo, preenche o campo de URL por conveni√™ncia
            if (storeLogo.startsWith('http')) {
                document.getElementById('logo-source-type').value = 'url';
                document.getElementById('logo-file-container').style.display = 'none';
                document.getElementById('logo-url-container').style.display = 'block';
                document.getElementById('store-logo-url').value = storeLogo;
            }
        }

        async function loadProducts() {
            const container = document.getElementById('products-list');
            try {
                const res = await fetch(`${API_BASE_URL}/api/merchant/products?store_id=${storeId}`);
                const products = await res.json();
                merchantProducts = products; // Salva os produtos no escopo do script


                // console.log('API Response for Products:', JSON.stringify(products, null, 2));

                if (products.length === 0) {
                    container.innerHTML = '<div style="color: #888; grid-column: 1/-1; text-align: center;">Nenhum produto cadastrado ainda.</div>';
                    return;
                }

                container.innerHTML = products.map((p, index) => `
            <div class="product-item">
                ${p.image_url ? `<img src="${getFullUrl(p.image_url)}" alt="${p.name}">` : ''}
                <h4>${p.name}</h4>
                <span class="price">R$ ${parseFloat(p.price).toFixed(2)}</span>
                <button class="edit-btn" onclick="triggerEdit(${index})">Editar</button>
                <button class="delete-btn" onclick="triggerDelete(${p.id})">Excluir</button>
            </div>
        `).join('');
            } catch (err) {
                console.error('Erro detalhado ao carregar produtos:', err);
                container.innerHTML = `<div style="color: #ff9800; grid-column: 1/-1; text-align: center;">Erro ao carregar produtos. Verifique o console para mais detalhes. (${err.message})</div>`;
            }
        }

        async function triggerDelete(productId) {
            if (!confirm('Tem certeza que deseja excluir este produto?')) {
                return;
            }

            try {
                const res = await fetch(`${API_BASE_URL}/api/delete-product`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ productId, store_id: storeId }),
                });

                if (res.ok) {
                    alert('Produto exclu√≠do com sucesso!');
                    loadProducts();
                } else {
                    const err = await res.json();
                    alert('Erro ao excluir produto: ' + (err.error || 'Falha no servidor'));
                }
            } catch (err) {
                alert('Erro de rede ao tentar excluir o produto.');
            }
        }

        // --- EVENTO: ATUALIZAR LOGO ---
        document.getElementById('logo-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            const sourceType = document.getElementById('logo-source-type').value;
            const fileInput = document.getElementById('store-logo');
            const urlInput = document.getElementById('store-logo-url');

            if (sourceType === 'file' && !fileInput.files[0]) {
                alert('Selecione um arquivo de imagem.');
                return;
            }
            if (sourceType === 'url' && !urlInput.value.trim()) {
                alert('Insira o link da imagem.');
                return;
            }

            try {
                btn.innerText = "Enviando...";
                btn.disabled = true;
                let publicUrl = '';

                if (sourceType === 'file') {
                    const compressedFile = await compressImage(fileInput.files[0], true);
                    const fileName = `logo-${storeId}-${Date.now()}.png`;

                    const { data, error } = await supabaseClient.storage
                        .from('logos')
                        .upload(fileName, compressedFile);

                    if (error) throw error;
                    publicUrl = supabaseClient.storage.from('logos').getPublicUrl(fileName).data.publicUrl;
                } else {
                    publicUrl = urlInput.value.trim();
                }

                await fetch(`${API_BASE_URL}/api/merchant/update-logo`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ store_id: storeId, logo_url: publicUrl })
                });

                localStorage.setItem('store_logo', publicUrl);
                document.getElementById('current-logo').innerHTML = `<img src="${publicUrl}" style="height:60px; border-radius:50%;">`;
                alert('Logo atualizada!');
            } catch (err) {
                console.error(err);
                alert('Erro ao atualizar logo: ' + err.message);
            } finally {
                btn.innerText = "Atualizar Logo";
                btn.disabled = false;
            }
        });

        // --- EVENTO: SALVAR PRODUTO ---
        document.getElementById('add-product-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const btn = e.target.querySelector('button');
            const isUpdating = btn.textContent === 'Atualizar';

            const sourceType = document.getElementById('image-source-type').value;
            const fileInput = document.getElementById('prod-image');
            const urlInput = document.getElementById('prod-image-url');
            const nameInput = document.getElementById('prod-name');
            const priceInput = document.getElementById('prod-price');
            const categoryInput = document.getElementById('prod-category');
            const promoInput = document.getElementById('prod-promo');
            const productFile = fileInput.files[0];
            const productUrl = urlInput.value.trim();

            // Se for um novo produto, a imagem √© obrigat√≥ria (seja arquivo ou link).
            // Se for uma atualiza√ß√£o, a imagem √© opcional.
            if (!isUpdating) {
                if (sourceType === 'file' && !productFile) {
                    alert('Por favor, selecione uma imagem para o novo produto.');
                    return;
                }
                if (sourceType === 'url' && !productUrl) {
                    alert('Por favor, insira o link da imagem para o novo produto.');
                    return;
                }
            }

            try {
                const btnOriginalText = btn.innerText;
                btn.innerText = "Enviando...";
                btn.disabled = true;

                let publicUrl = '';

                if (sourceType === 'file' && productFile) {
                    // Se um novo arquivo foi selecionado, faz o upload
                    const fileName = `prod-${storeId}-${Date.now()}.jpg`;
                    const { data, error } = await supabaseClient.storage
                        .from('produtos')
                        .upload(fileName, productFile);

                    if (error) throw error;

                    publicUrl = supabaseClient.storage.from('produtos').getPublicUrl(fileName).data.publicUrl;
                } else if (sourceType === 'url' && productUrl) {
                    // Se for link, usa o link diretamente
                    publicUrl = productUrl;
                } else {
                    // Se nenhum arquivo novo foi selecionado (durante uma atualiza√ß√£o), reutiliza a URL existente.
                    publicUrl = document.getElementById('existing-image-url')?.value || '';
                }

                const productData = {
                    name: nameInput.value,
                    price: priceInput.value,
                    category: categoryInput.value,
                    promo_price: promoInput.value || null,
                    image_url: publicUrl,
                    store_id: storeId
                };

                const res = await fetch(`${API_BASE_URL}/api/products`, {
                    method: 'POST', // O backend j√° faz "upsert", ent√£o POST funciona para criar e atualizar
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(productData)
                });

                if (res.ok) {
                    alert(`Produto ${isUpdating ? 'atualizado' : 'cadastrado'} com sucesso!`);
                    e.target.reset();
                    // Reset visibility
                    document.getElementById('image-source-type').value = 'file';
                    document.getElementById('image-file-container').style.display = 'block';
                    document.getElementById('image-url-container').style.display = 'none';
                    btn.textContent = 'Salvar';

                    loadProducts();
                } else {
                    const err = await res.json();
                    console.error('Erro do servidor ao salvar produto:', err);
                    alert('Erro no servidor: ' + (err.error || err.details || 'Falha ao salvar'));
                }
            } catch (err) {
                console.error("Erro completo:", err);
                alert('Erro ao processar produto: ' + err.message);
            } finally {
                if (btn.textContent !== 'Atualizar') {
                    btn.innerText = "Salvar";
                } else {
                    btn.innerText = "Atualizar";
                }
                btn.disabled = false;
            }
        });
        function logout() {
            // 1. Limpa todos os dados de login salvos no navegador (ID, Nome, Logo)
            localStorage.clear();

            // 2. Opcional: Limpa tamb√©m os dados da sess√£o administrativa se houver
            sessionStorage.clear();

            // 3. Redireciona para a p√°gina inicial ou de login
            window.location.href = 'index.html';
        }

        function triggerEdit(index) {
            const product = merchantProducts[index];
            if (!product) return;

            // Preenche o formul√°rio com os dados do produto
            document.getElementById('prod-name').value = product.name;
            document.getElementById('prod-price').value = parseFloat(product.price).toFixed(2);
            document.getElementById('prod-category').value = product.category;
            document.getElementById('prod-promo').value = product.promo_price ? parseFloat(product.promo_price).toFixed(2) : '';

            const form = document.getElementById('add-product-form');

            // Se a imagem for um link externo (n√£o do supabase storage), podemos sugerir o modo "Link"
            const isExternal = product.image_url && !product.image_url.includes('supabase.co');
            if (isExternal) {
                document.getElementById('image-source-type').value = 'url';
                document.getElementById('image-file-container').style.display = 'none';
                document.getElementById('image-url-container').style.display = 'block';
                document.getElementById('prod-image-url').value = product.image_url;
            } else {
                document.getElementById('image-source-type').value = 'file';
                document.getElementById('image-file-container').style.display = 'block';
                document.getElementById('image-url-container').style.display = 'none';
                document.getElementById('prod-image-url').value = '';
            }

            // Armazena a URL da imagem existente em um campo oculto
            let existingImgField = document.getElementById('existing-image-url');
            if (!existingImgField) {
                existingImgField = document.createElement('input');
                existingImgField.type = 'hidden';
                existingImgField.id = 'existing-image-url';
                form.appendChild(existingImgField);
            }
            existingImgField.value = product.image_url || '';

            // Altera o texto do bot√£o e foca no formul√°rio
            form.querySelector('button').textContent = 'Atualizar';
            form.scrollIntoView({ behavior: 'smooth' });
        }


        loadProducts();
        // Footer Global - JBSousaTech
        const footer = document.createElement('footer');
        footer.innerHTML = `
            <div style="text-align: center; padding: 20px; margin-top: 40px; border-top: 1px solid #333; color: #888; font-size: 0.9rem;">
                &copy; ${new Date().getFullYear()} JbsousaTech - Todos os direitos reservados
            </div>
        `;
        document.body.appendChild(footer);
    </script>
</body>

</html>